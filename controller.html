<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBS æ§åˆ¶å™¨ (VOæ–°èæ¨¡å¼)</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f0f0; padding: 20px; display: flex; gap: 20px; height: 90vh; }
        
        .panel-left { flex: 1.2; display: flex; flex-direction: column; }
        
        .toolbar { background: #e9ecef; padding: 10px; border-radius: 5px 5px 0 0; border: 1px solid #ccc; border-bottom: none; display: flex; gap: 8px; flex-wrap: wrap; }
        .tool-btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold; display: flex; align-items: center; gap: 5px; box-shadow: 1px 1px 3px rgba(0,0,0,0.1); }
        .tool-btn:hover { transform: translateY(-1px); opacity: 0.9; }

        .btn-title { background: #00ffcc; color: #004d40; }
        .btn-img { background: #ff9900; color: #4e3400; }
        .btn-vid-block { background: #d63384; color: white; } /* ç´«ç´…è‰² VO æŒ‰éˆ• */
        .btn-search { background: #6c757d; color: white; }
        .btn-clear { background: #dc3545; color: white; margin-left: auto; }

        textarea { flex: 1; padding: 15px; font-size: 16px; border: 1px solid #ccc; border-radius: 0 0 5px 5px; resize: none; margin-bottom: 10px; font-family: monospace; white-space: pre; overflow-wrap: normal; overflow-x: scroll; line-height: 1.5; }
        
        .action-area { display: flex; gap: 10px; }
        .btn-big { padding: 12px; cursor: pointer; border: none; border-radius: 5px; font-size: 18px; font-weight: bold; flex: 1; }
        .btn-load { background: #28a745; color: white; }
        .btn-wipe { background: #333; color: white; flex: 0.3;}

        .panel-right { flex: 0.8; display: flex; flex-direction: column; background: #333; color: white; padding: 20px; border-radius: 10px; }
        .preview-box { background: #000; border: 2px solid #555; height: 200px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; text-align: center; padding: 10px; overflow: hidden; flex-direction: column; position: relative; }
        
        /* é è¦½èƒŒæ™¯ */
        .preview-bg { position: absolute; top:0; left:0; width:100%; height:100%; object-fit: cover; opacity: 0.4; z-index: 0; }
        .current-text { color: #fff; font-size: 24px; font-weight: bold; line-height: 1.4; z-index: 1; text-shadow: 2px 2px 0 #000; position: relative;}
        
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 12px; margin-bottom: 5px; display: inline-block;}
        .tag-vo { background: #d63384; color: white; }

        .controls { display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-top: auto; }
        .btn-nav { background: #007acc; color: white; padding: 20px; font-size: 20px; border: none; cursor: pointer; border-radius: 5px; }
    </style>
</head>
<body>

    <div class="panel-left">
        <h3>æ–°èç¨¿ç·¨è¼¯ (VO èƒŒæ™¯æ¨¡å¼)</h3>
        
        <div class="toolbar">
            <button class="tool-btn btn-title" onclick="insertTitle()">ğŸ“ æ¨™é¡Œ</button>
            <button class="tool-btn btn-vid-block" onclick="insertVideoBlock()">ğŸ¬ å½±ç‰‡èƒŒæ™¯å€å¡Š (VO)</button>
            <button class="tool-btn btn-img" onclick="insertImage()">ğŸ–¼ï¸ åœ–ç‰‡(å…¨è¢å¹•)</button>
            <button class="tool-btn btn-search" onclick="openGoogleImages()">ğŸ” æ‰¾åœ–</button>
            <button class="tool-btn btn-clear" onclick="clearEditor()">âŒ æ¸…ç©º</button>
        </div>

        <textarea id="script-input" placeholder="è¼¸å…¥æ–‡å­—... æˆ–é¸å–æ–‡å­—å¾Œé»æ“Šã€Œå½±ç‰‡èƒŒæ™¯å€å¡Šã€...">
[T:æ™šé–“æ–°èå¿«å ±]
å„ä½è§€çœ¾å¤§å®¶å¥½ï¼Œæ­¡è¿æ”¶çœ‹ã€‚
[VID IN=5 OUT=15 URL=https://www.w3schools.com/html/mov_bbb.mp4]
ç¾åœ¨æˆ‘å€‘çœ‹åˆ°çš„æ˜¯ç¾å ´ç•«é¢ã€‚
é€éé€™å€‹ç•«é¢æˆ‘å€‘å¯ä»¥äº†è§£...
ç¾å ´æ°£æ°›éå¸¸ç†±é¬§ã€‚
[/VID]
å ±å°çµæŸï¼Œè¬è¬æ”¶çœ‹ã€‚
        </textarea>
        
        <div class="action-area">
            <button class="btn-big btn-load" onclick="initScript()">ğŸš€ é‡ç½®ä¸¦é–‹å§‹ (Load)</button>
            <button class="btn-big btn-wipe" onclick="clearDisplay()">â¬› é»‘å±</button>
        </div>
    </div>

    <div class="panel-right">
        <div style="color:#aaa; font-size:12px; margin-bottom:5px;">ğŸ”´ æ­£åœ¨é¡¯ç¤º (ON AIR)</div>
        <div class="preview-box" id="preview-box-current">
            <div id="preview-current" class="current-text">---</div>
        </div>

        <div style="color:#aaa; font-size:12px; margin-bottom:5px;">â­ï¸ ä¸‹ä¸€å¥</div>
        <div class="preview-box" style="height: 100px; background: #222;">
            <div id="preview-next" class="current-text" style="font-size:16px;">---</div>
        </div>

        <div class="controls">
            <button class="btn-nav" onclick="prevSlide()">â¬…ï¸ ä¸Šä¸€å¥</button>
            <button class="btn-nav" onclick="nextSlide()">ä¸‹ä¸€å¥ (Space)</button>
        </div>
        <div style="text-align:right; color:#888; font-size:12px; margin-top:10px;" id="slide-status">0 / 0</div>
    </div>

    <script>
        let slides = [];
        let currentIndex = -1;
        const textArea = document.getElementById('script-input');

        // --- æŒ‰éˆ•åŠŸèƒ½ ---
        function insertTitle() {
            const val = prompt("è¼¸å…¥æ¨™é¡Œï¼š");
            if (val) insertAtCursor(`\n[T:${val}]\n`);
        }
        function insertImage() {
            const val = prompt("è¼¸å…¥å…¨è¢å¹•åœ–ç‰‡ç¶²å€ï¼š");
            if (val) insertAtCursor(`\n[IMG:${val}]\n`);
        }
        
        // æ’å…¥å½±ç‰‡åŒ…è¦†å€å¡Š
        function insertVideoBlock() {
            const url = prompt("è¼¸å…¥èƒŒæ™¯å½±ç‰‡ç¶²å€ (mp4)ï¼š");
            if (!url) return;
            const inPoint = prompt("é–‹å§‹ç§’æ•¸ (IN)ï¼š", "0");
            const outPoint = prompt("çµæŸç§’æ•¸ (OUT)ï¼š", "10");

            // æª¢æŸ¥æœ‰æ²’æœ‰é¸å–æ–‡å­—
            const start = textArea.selectionStart;
            const end = textArea.selectionEnd;
            const selectedText = textArea.value.substring(start, end);

            const openTag = `\n[VID IN=${inPoint} OUT=${outPoint} URL=${url}]\n`;
            const closeTag = `\n[/VID]\n`;

            if (selectedText.trim().length > 0) {
                // åŒ…ä½é¸å–çš„æ–‡å­—
                const replacement = openTag + selectedText + closeTag;
                textArea.setRangeText(replacement);
            } else {
                // æ’å…¥ç©ºå€å¡Š
                insertAtCursor(`${openTag}åœ¨é€™è£¡è¼¸å…¥è¦æœ‰èƒŒæ™¯å½±ç‰‡çš„æ–‡å­—...\nç¬¬äºŒå¥...\n${closeTag}`);
            }
        }

        function openGoogleImages() {
            const val = prompt("æœå°‹é—œéµå­—ï¼š", "æ–°è");
            if (val) window.open(`https://www.google.com/search?tbm=isch&q=${encodeURIComponent(val)}`, '_blank');
        }
        function clearEditor() { if(confirm("æ¸…ç©ºï¼Ÿ")) textArea.value = ""; }
        
        function insertAtCursor(text) {
            const start = textArea.selectionStart;
            const end = textArea.selectionEnd;
            textArea.value = textArea.value.substring(0, start) + text + textArea.value.substring(end);
            textArea.focus();
        }

        // --- è§£æé‚è¼¯ (æ”¯æ´å€å¡Š) ---
        function initScript() {
            parseScript(textArea.value);
            if (slides.length > 0) {
                currentIndex = 0;
                updateState();
            }
        }

        function parseScript(text) {
            slides = [];
            // 1. å…ˆæŠŠå€å¡Šåˆ‡å‡ºä¾†
            // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼å°‹æ‰¾ [VID ...] ... [/VID]
            // æ³¨æ„ï¼šJSçš„æ­£å‰‡ä¸æ”¯æ´ dotAll (è·¨è¡Œ)ï¼Œè¦ç”¨ [\s\S]
            const blockRegex = /\[VID\s+IN=([\d\.]+)\s+OUT=([\d\.]+)\s+URL=(.*?)\]([\s\S]*?)\[\/VID\]/gi;
            
            // æˆ‘å€‘ä½¿ç”¨ä¸€å€‹æŠ€å·§ï¼šå…ˆè™•ç†å€å¡Šï¼ŒæŠŠå€å¡Šæ›¿æ›æˆç‰¹æ®Šçš„ Placeholdersï¼Œ
            // è§£æå®Œæ™®é€šè¡Œä¹‹å¾Œï¼Œå†å±•é–‹ Placeholdersã€‚
            // ä½†ç‚ºäº†ç°¡å–®èˆ‡é †åºæ­£ç¢ºï¼Œæˆ‘å€‘é€è¡Œæƒææ¯”è¼ƒç©©ã€‚

            const lines = text.split('\n');
            let currentBgVideo = null; // ç•¶å‰æ˜¯å¦åœ¨å½±ç‰‡å€å¡Šå…§

            lines.forEach(line => {
                line = line.trim();
                if (!line) return;

                // æª¢æŸ¥æ˜¯å¦æ˜¯å€å¡Šé–‹å§‹ [VID ...]
                const startMatch = line.match(/^\[VID\s+IN=([\d\.]+)\s+OUT=([\d\.]+)\s+URL=(.*?)\]/i);
                if (startMatch) {
                    currentBgVideo = {
                        in: startMatch[1],
                        out: startMatch[2],
                        url: startMatch[3]
                    };
                    return; // é€™ä¸€è¡Œæ˜¯æ¨™ç±¤ï¼Œè·³é
                }

                // æª¢æŸ¥æ˜¯å¦æ˜¯å€å¡ŠçµæŸ [/VID]
                if (line.match(/^\[\/VID\]/i)) {
                    currentBgVideo = null;
                    return; // é€™ä¸€è¡Œæ˜¯æ¨™ç±¤ï¼Œè·³é
                }

                // è™•ç†å…§å®¹
                let slide = {};

                if (line.startsWith('[T:') && line.endsWith(']')) {
                    slide = { type: 'title', content: line.substring(3, line.length - 1) };
                } else if (line.startsWith('[IMG:') && line.endsWith(']')) {
                    // å…¨è¢å¹•åœ–ç‰‡
                    slide = { type: 'text', content: '', bgType: 'image', bgContent: line.substring(5, line.length - 1) };
                } else {
                    // æ™®é€šæ–‡å­—
                    slide = { type: 'text', content: line };
                }

                // å¦‚æœç•¶å‰åœ¨å½±ç‰‡å€å¡Šå…§ï¼ŒåŠ ä¸ŠèƒŒæ™¯å±¬æ€§
                if (currentBgVideo && slide.type === 'text') {
                    slide.bgType = 'video';
                    slide.bgContent = currentBgVideo.url;
                    slide.inPoint = currentBgVideo.in;
                    slide.outPoint = currentBgVideo.out;
                }

                slides.push(slide);
            });
        }

        // --- æ§åˆ¶é‚è¼¯ (åŒå‰) ---
        function nextSlide() {
            if (currentIndex < slides.length - 1) { currentIndex++; updateState(); }
        }
        function prevSlide() {
            if (currentIndex > 0) { currentIndex--; updateState(); }
        }
        function clearDisplay() {
            sendToDisplay({ type: 'text', content: '' });
            document.getElementById('preview-current').innerText = '';
        }

        function updateState() {
            const current = slides[currentIndex];
            const next = slides[currentIndex + 1];
            sendToDisplay(current);
            renderPreview('preview-current', current, 'preview-box-current');
            renderPreview('preview-next', next);
            document.getElementById('slide-status').innerText = `${currentIndex + 1} / ${slides.length}`;
        }

        function renderPreview(elId, slide, boxId = null) {
            const el = document.getElementById(elId);
            if (!slide) { el.innerHTML = '(çµæŸ)'; return; }

            // æ›´æ–°é è¦½ç›’å­çš„èƒŒæ™¯
            if (boxId) {
                const box = document.getElementById(boxId);
                // æ¸…é™¤èˆŠèƒŒæ™¯
                const oldBg = box.querySelector('.preview-bg');
                if(oldBg) oldBg.remove();

                if (slide.bgType === 'video' || slide.bgType === 'image') {
                    const bg = document.createElement(slide.bgType === 'video' ? 'video' : 'img');
                    bg.src = slide.bgContent;
                    bg.className = 'preview-bg';
                    if(slide.bgType === 'video') { bg.muted = true; bg.currentTime = slide.inPoint; }
                    box.prepend(bg); // æ’åœ¨æœ€å‰é¢
                }
            }

            // æ›´æ–°æ–‡å­—
            let html = '';
            if (slide.type === 'title') {
                html = `<span class="tag" style="background:#00ffcc;color:black;">æ¨™é¡Œ</span><br>${slide.content}`;
            } else if (slide.type === 'text') {
                if (slide.bgType === 'video') {
                     html = `<span class="tag tag-vo">VOæ¨¡å¼</span> <span style="font-size:10px">IN:${slide.inPoint} OUT:${slide.outPoint}</span><br>${slide.content}`;
                } else {
                     html = slide.content;
                }
            }
            el.innerHTML = html;
        }

        function sendToDisplay(data) {
            localStorage.setItem('obs_prompter_update', JSON.stringify(data));
            localStorage.setItem('obs_prompter_timestamp', Date.now());
        }

        window.addEventListener('keydown', (e) => {
            if (document.activeElement !== textArea || e.ctrlKey) {
                if (e.code === 'Space') { e.preventDefault(); nextSlide(); }
                else if (e.code === 'ArrowLeft') prevSlide();
                else if (e.code === 'ArrowRight') nextSlide();
            }
        });
    </script>
</body>
</html>