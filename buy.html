<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‚¡ç¥¨è¼¸å…¥å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .tab-btn { flex: 1; padding: 12px; text-align: center; font-size: 14px; font-weight: bold; color: #9ca3af; border-bottom: 3px solid transparent; transition: all 0.2s; }
        .tab-active { color: #2563eb; border-bottom-color: #2563eb; background: #eff6ff; }
        .loader { width: 16px; height: 16px; border: 2px solid #ddd; border-top-color: #2563eb; border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }
        input, select { -webkit-appearance: none; } /* æ‰‹æ©Ÿç‰ˆå„ªåŒ– */
    </style>
</head>
<body class="text-slate-800 pb-10">

    <div class="max-w-md mx-auto min-h-screen bg-white shadow-xl overflow-hidden flex flex-col">
        
        <div class="bg-slate-900 text-white p-4 flex justify-between items-center sticky top-0 z-10">
            <h1 class="font-bold text-lg flex items-center gap-2">ğŸ“ è‚¡ç¥¨è¼¸å…¥å·¥å…·</h1>
            <div id="status-light" class="w-3 h-3 rounded-full bg-green-500 shadow-[0_0_5px_#22c55e]"></div>
        </div>

        <div class="flex border-b border-gray-200 sticky top-[60px] bg-white z-10">
            <button onclick="switchTab('request')" id="tab-request" class="tab-btn tab-active">å§”è¨—ä¸‹å–®</button>
            <button onclick="switchTab('pending')" id="tab-pending" class="tab-btn relative">
                å¾…è¾¦ç¢ºèª <span id="badge-count" class="hidden absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full"></span>
            </button>
            <button onclick="switchTab('payment')" id="tab-payment" class="tab-btn">ç™»è¨˜åŒ¯æ¬¾</button>
        </div>

        <div id="page-request" class="p-5 flex-1 flex flex-col gap-4">
            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                <h3 class="font-bold text-blue-800 mb-3 text-sm">æ–°å¢è³¼è²·/è³£å‡ºéœ€æ±‚</h3>
                
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="text-xs text-gray-500 font-bold ml-1">æ—¥æœŸ</label>
                        <input type="date" id="req-date" class="w-full border rounded-lg p-3 bg-white text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 font-bold ml-1">å‹•ä½œ</label>
                        <select id="req-type" class="w-full border rounded-lg p-3 bg-white text-sm">
                            <option value="buy">ğŸ”µ è²·é€²</option>
                            <option value="sell">ğŸ”´ è³£å‡º</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="text-xs text-gray-500 font-bold ml-1">è‚¡ç¥¨ä»£è™Ÿ</label>
                    <input type="text" id="req-ticker" value="006208" class="w-full border rounded-lg p-3 text-center text-lg font-bold tracking-widest bg-white">
                </div>

                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div>
                        <label class="text-xs text-gray-500 font-bold ml-1">é ç®—/åƒ¹æ ¼</label>
                        <input type="number" id="req-price" step="0.01" class="w-full border rounded-lg p-3 bg-white text-sm" placeholder="ä¾‹å¦‚ 168">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 font-bold ml-1">è‚¡æ•¸</label>
                        <input type="number" id="req-shares" class="w-full border rounded-lg p-3 bg-white text-sm" placeholder="ä¾‹å¦‚ 100">
                    </div>
                </div>

                <button onclick="submitRequest()" id="btn-req" class="w-full bg-blue-600 active:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-200 transition transform active:scale-95 flex justify-center items-center gap-2">
                    é€å‡ºå§”è¨—å–®
                </button>
            </div>
            <p class="text-xs text-gray-400 text-center">é€å‡ºå¾Œï¼Œè«‹æœ‹å‹åˆ°ã€Œå¾…è¾¦ç¢ºèªã€é é¢åŸ·è¡Œ</p>
        </div>

        <div id="page-pending" class="p-5 flex-1 hidden">
            <div class="flex justify-between items-end mb-3">
                <h3 class="font-bold text-gray-700 text-sm">ç­‰å¾…æˆäº¤åˆ—è¡¨</h3>
                <button onclick="loadPendingData()" class="text-xs text-blue-500 font-bold bg-blue-50 px-2 py-1 rounded">â†» é‡æ–°æ•´ç†</button>
            </div>
            
            <div id="pending-list" class="space-y-3">
                <div class="text-center py-10 text-gray-400 text-sm">è¼‰å…¥ä¸­...</div>
            </div>
        </div>

        <div id="page-payment" class="p-5 flex-1 hidden">
            <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                <h3 class="font-bold text-green-800 mb-3 text-sm">è½‰å¸³çµ¦æœ‹å‹</h3>
                
                <div class="mb-3">
                    <label class="text-xs text-gray-500 font-bold ml-1">åŒ¯æ¬¾æ—¥æœŸ</label>
                    <input type="date" id="pay-date" class="w-full border rounded-lg p-3 bg-white text-sm">
                </div>

                <div class="mb-4">
                    <label class="text-xs text-gray-500 font-bold ml-1">é‡‘é¡ (TWD)</label>
                    <input type="number" id="pay-amount" class="w-full border rounded-lg p-3 bg-white text-xl font-bold text-green-600" placeholder="$">
                </div>

                <button onclick="submitPayment()" id="btn-pay" class="w-full bg-green-600 active:bg-green-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-green-200 transition transform active:scale-95 flex justify-center items-center gap-2">
                    ç¢ºèªå·²åŒ¯æ¬¾
                </button>
            </div>
        </div>

    </div>

    <script>
        // ğŸ‘‡ğŸ‘‡ğŸ‘‡ è«‹åœ¨é€™è£¡è²¼ä¸Šä½ çš„ GAS ç¶²å€ ğŸ‘‡ğŸ‘‡ğŸ‘‡
        const GAS_URL = "YOUR_GAS_URL_HERE"; 
        // ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†ğŸ‘†

        // åˆå§‹åŒ–æ—¥æœŸ
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('req-date').value = today;
        document.getElementById('pay-date').value = today;

        // å•Ÿå‹•æ™‚è®€å–è³‡æ–™
        loadPendingData();

        function switchTab(tabName) {
            ['request', 'pending', 'payment'].forEach(t => {
                document.getElementById('page-' + t).classList.add('hidden');
                document.getElementById('tab-' + t).className = "tab-btn";
            });
            document.getElementById('page-' + tabName).classList.remove('hidden');
            document.getElementById('tab-' + tabName).className = "tab-btn tab-active";

            if(tabName === 'pending') loadPendingData();
        }

        function loadPendingData() {
            const list = document.getElementById('pending-list');
            document.getElementById('status-light').className = "w-3 h-3 rounded-full bg-yellow-400 animate-pulse"; // Loading status

            fetch(GAS_URL)
                .then(res => res.json())
                .then(data => {
                    document.getElementById('status-light').className = "w-3 h-3 rounded-full bg-green-500";
                    renderPendingList(data.pending);
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('status-light').className = "w-3 h-3 rounded-full bg-red-500";
                    list.innerHTML = `<div class="text-center py-4 text-red-400 text-sm">é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²å€</div>`;
                });
        }

        function renderPendingList(data) {
            const list = document.getElementById('pending-list');
            const badge = document.getElementById('badge-count');
            list.innerHTML = '';

            if (!data || data.length === 0) {
                list.innerHTML = `<div class="text-center py-10 text-gray-300 text-sm flex flex-col items-center"><span class="text-3xl mb-2">ğŸ’¤</span>ç›®å‰æ²’æœ‰å¾…è¾¦å§”è¨—</div>`;
                badge.classList.add('hidden');
                return;
            }

            // æ›´æ–°å°ç´…é»
            badge.classList.remove('hidden');

            data.forEach(item => {
                // è³‡æ–™çµæ§‹: [ID, Time, Date, Ticker, Type, Price, Shares]
                const id = item[0];
                const dateShort = item[2].substring(5).replace('-','/');
                const isBuy = item[4] === 'buy';
                
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center";
                card.innerHTML = `
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="px-2 py-0.5 rounded text-xs font-bold ${isBuy ? 'bg-blue-100 text-blue-600':'bg-red-100 text-red-600'}">
                                ${isBuy ? 'è²·é€²':'è³£å‡º'}
                            </span>
                            <span class="font-bold text-slate-800">${item[3]}</span>
                        </div>
                        <div class="text-xs text-gray-500">
                            ${dateShort} â€¢ ${item[6]}è‚¡ @ $${item[5]}
                        </div>
                    </div>
                    <button onclick="confirmItem('${id}', '${item[3]}', '${item[4]}', ${item[6]}, ${item[5]}, '${item[2]}')" 
                        class="bg-slate-800 text-white text-xs font-bold px-4 py-2 rounded-lg active:bg-black">
                        âœ… æˆäº¤
                    </button>
                `;
                list.appendChild(card);
            });
        }

        // é€å‡ºå§”è¨—
        function submitRequest() {
            const btn = document.getElementById('btn-req');
            const payload = {
                action: "add_request",
                date: document.getElementById('req-date').value,
                ticker: document.getElementById('req-ticker').value,
                type: document.getElementById('req-type').value,
                price: document.getElementById('req-price').value,
                shares: document.getElementById('req-shares').value
            };

            if(!payload.price || !payload.shares) return alert("è«‹è¼¸å…¥åƒ¹æ ¼èˆ‡è‚¡æ•¸");
            
            setLoading(btn, true);
            
            fetch(GAS_URL, { method: "POST", body: JSON.stringify(payload) })
            .then(res => res.json())
            .then(() => {
                alert("å§”è¨—å·²é€å‡ºï¼");
                document.getElementById('req-shares').value = ''; // æ¸…ç©ºè‚¡æ•¸
                setLoading(btn, false, "é€å‡ºå§”è¨—å–®");
                switchTab('pending'); // è‡ªå‹•è·³è½‰å»æª¢æŸ¥
            });
        }

        // æœ‹å‹æŒ‰ç¢ºèªæˆäº¤
        function confirmItem(id, ticker, type, shares, defaultPrice, date) {
            const realPrice = prompt(`ç¢ºèª ${ticker} æˆäº¤åƒ¹æ ¼ï¼š`, defaultPrice);
            if (realPrice) {
                const amount = Math.round(parseFloat(realPrice) * parseInt(shares));
                const payload = {
                    action: "confirm_request",
                    id: id,
                    date: date,
                    ticker: ticker,
                    type: type,
                    shares: shares,
                    price: parseFloat(realPrice),
                    amount: amount
                };
                
                // æš«æ™‚é¡¯ç¤º Loading
                document.getElementById('pending-list').innerHTML = '<div class="text-center py-10"><span class="loader"></span><div class="text-xs text-gray-400 mt-2">è™•ç†æˆäº¤ä¸­...</div></div>';

                fetch(GAS_URL, { method: "POST", body: JSON.stringify(payload) })
                .then(res => res.json())
                .then(() => {
                    loadPendingData(); // é‡æ–°æ•´ç†
                });
            }
        }

        // é€å‡ºåŒ¯æ¬¾
        function submitPayment() {
            const btn = document.getElementById('btn-pay');
            const payload = {
                action: "add_payment",
                date: document.getElementById('pay-date').value,
                amount: document.getElementById('pay-amount').value,
                note: "APPè¼¸å…¥"
            };

            if(!payload.amount) return alert("è«‹è¼¸å…¥é‡‘é¡");

            setLoading(btn, true);

            fetch(GAS_URL, { method: "POST", body: JSON.stringify(payload) })
            .then(res => res.json())
            .then(() => {
                alert("åŒ¯æ¬¾å·²ç™»è¨˜");
                document.getElementById('pay-amount').value = '';
                setLoading(btn, false, "ç¢ºèªå·²åŒ¯æ¬¾");
            });
        }

        function setLoading(btn, isLoading, text) {
            if(isLoading) {
                btn.disabled = true;
                btn.innerHTML = '<span class="loader"></span> è™•ç†ä¸­...';
                btn.classList.add('opacity-70');
            } else {
                btn.disabled = false;
                btn.innerHTML = text;
                btn.classList.remove('opacity-70');
            }
        }
    </script>
</body>
</html>
