<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è‚¡ç¥¨ç®¡å®¶ ç©©å®šç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; background-color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-top: 1px solid #e2e8f0; display: flex; justify-content: space-around; padding-bottom: env(safe-area-inset-bottom); z-index: 50; }
        .nav-btn { flex: 1; padding: 10px 0; text-align: center; font-size: 10px; color: #94a3b8; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: color 0.2s; }
        .nav-active { color: #2563eb; font-weight: 700; }
        .nav-icon { font-size: 20px; margin-bottom: 2px; }
        .loader { width: 14px; height: 14px; border: 2px solid #cbd5e1; border-top-color: #2563eb; border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; background-color: #f8fafc; }
        .chart-container { transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out; max-height: 0; opacity: 0; overflow: hidden; }
        .chart-container.open { max-height: 250px; opacity: 1; margin-bottom: 1rem; }
        .custom-checkbox { width: 1.2rem; height: 1.2rem; }
    </style>
</head>
<body class="text-slate-800">

    <div class="app-container pb-24">
        
        <div class="bg-slate-900 text-white p-4 sticky top-0 z-40 shadow-md flex justify-between items-center">
            <h1 class="font-bold text-lg tracking-wide flex items-center gap-2">
                <span id="header-icon">ğŸ“</span>
                <span id="page-title">å§”è¨—ä¸‹å–®</span>
            </h1>
            <div id="status-indicator" class="text-[10px] bg-slate-800 border border-slate-700 px-2 py-1 rounded text-gray-400 font-mono" onclick="refreshData()">â— é€£ç·šä¸­</div>
        </div>

        <div id="page-request" class="p-4 page-content animate-fade">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200 space-y-4">
                <div class="flex gap-3">
                    <input type="date" id="req-date" class="flex-1 border border-gray-300 rounded-xl p-3 bg-gray-50 text-sm outline-none focus:ring-2 focus:ring-blue-500">
                    <select id="req-type" class="w-24 border border-gray-300 rounded-xl p-3 bg-gray-50 text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="buy">è²·é€²</option>
                        <option value="sell">è³£å‡º</option>
                    </select>
                </div>

                <div>
                    <div class="relative flex items-center gap-2">
                        <input type="text" id="req-ticker" value="006208" class="flex-1 border border-gray-300 rounded-xl p-3 text-center text-xl font-bold tracking-[0.1em] placeholder-gray-300 outline-none focus:ring-2 focus:ring-blue-500" placeholder="ä»£è™Ÿ">
                        <button onclick="fetchHistory()" id="btn-chart" class="bg-indigo-50 text-indigo-600 border border-indigo-100 p-3 rounded-xl font-bold text-xs whitespace-nowrap active:scale-95 transition">
                            ğŸ“ˆ èµ°å‹¢
                        </button>
                    </div>
                </div>

                <div id="chart-wrapper" class="chart-container bg-slate-50 rounded-xl border border-slate-200 relative">
                    <button onclick="toggleChart(false)" class="absolute top-1 right-2 text-gray-400 hover:text-gray-600 text-lg z-10">Ã—</button>
                    <div class="h-48 w-full p-2"><canvas id="trendChart"></canvas></div>
                </div>

                <div class="flex gap-2 items-end">
                    <div class="flex-1">
                        <label class="text-xs text-gray-500 ml-1 font-bold">å–®åƒ¹</label>
                        <input type="number" id="req-price" step="0.01" class="w-full border border-gray-300 rounded-xl p-3 bg-white text-lg font-bold text-blue-600 outline-none focus:ring-2 focus:ring-blue-500" placeholder="åƒ¹æ ¼" oninput="calcByShares()">
                    </div>
                    <button onclick="fetchPrice()" id="btn-price" class="bg-slate-100 hover:bg-slate-200 text-slate-600 border border-slate-200 font-bold px-4 py-3 rounded-xl mb-[1px] active:scale-95 transition text-sm">
                        ğŸ” æŠ“ç¾åƒ¹
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-3 bg-slate-50 p-3 rounded-xl border border-slate-100 relative">
                    <div>
                        <label class="text-xs text-gray-500 ml-1 font-bold">è‚¡æ•¸</label>
                        <input type="number" id="req-shares" class="w-full border border-gray-300 rounded-xl p-3 bg-white text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="è‚¡æ•¸" oninput="calcByShares()">
                    </div>
                    <div class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 text-gray-400 text-xs bg-slate-50 p-1">â†”ï¸</div>
                    <div class="relative">
                        <label class="text-xs text-gray-500 ml-1 font-bold text-blue-600">æˆ– ç¸½é‡‘é¡</label>
                        <span class="absolute left-3 top-[34px] text-gray-400 text-sm">$</span>
                        <input type="number" id="req-total" class="w-full border border-blue-200 rounded-xl p-3 pl-6 bg-white text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500" placeholder="é ç®—" oninput="calcByTotal()">
                    </div>
                </div>
                
                <button onclick="submitRequest()" id="btn-req" class="w-full bg-blue-600 hover:bg-blue-500 active:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 transition transform active:scale-[0.98] text-lg">
                    é€å‡ºå§”è¨—å–®
                </button>
            </div>
        </div>

        <div id="page-pending" class="p-4 page-content hidden">
            <div class="bg-yellow-50 text-yellow-800 text-xs p-3 rounded-xl mb-4 text-center border border-yellow-100">
                ğŸ”” é»æ“Šç¢ºèªå¾Œï¼Œè«‹è¼¸å…¥å¯¦éš›æˆäº¤åƒ¹
            </div>
            <div id="pending-list" class="space-y-3"></div>
        </div>

        <div id="page-profit" class="p-4 page-content hidden space-y-4">
            <div class="bg-gradient-to-br from-slate-800 to-black text-white rounded-2xl p-6 shadow-xl relative overflow-hidden">
                <div class="absolute -right-4 -top-4 opacity-10 text-9xl">ğŸ’°</div>
                <div class="relative z-10">
                    <div class="text-xs text-gray-400 font-bold tracking-wider mb-1">å·²å¯¦ç¾æç›Š (è½è¢‹)</div>
                    <div class="text-3xl font-bold font-mono tracking-tight" id="total-realized-pl">$0</div>
                </div>
            </div>
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-200">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <div class="text-xs text-gray-400 font-bold tracking-wider mb-1">æœªå¯¦ç¾æç›Š (å¸³é¢)</div>
                        <div class="text-3xl font-bold flex items-baseline gap-2 font-mono">
                            <span id="total-unrealized-pl" class="text-gray-300">$0</span>
                        </div>
                    </div>
                    <button onclick="updateAllPrices()" id="btn-update-all" class="bg-blue-50 text-blue-600 hover:bg-blue-100 text-xs font-bold px-3 py-2 rounded-lg transition border border-blue-100">ğŸ”„ æ›´æ–°ç¾åƒ¹</button>
                </div>
                <div class="text-xs text-gray-500 flex justify-between items-center border-t border-gray-100 pt-3">
                    <span>æŒè‚¡ç¸½å¸‚å€¼</span>
                    <span id="total-market-value" class="text-slate-800 font-bold font-mono">$0</span>
                </div>
            </div>
            <button onclick="refreshData()" class="w-full text-center text-[10px] text-gray-400 py-2">å¦‚æ•¸æ“šæœªæ›´æ–°ï¼Œè«‹é»æ­¤é‡æ–°è¼‰å…¥</button>
            <div id="portfolio-list" class="space-y-3 pb-8"></div>
        </div>

        <div id="page-records" class="p-0 page-content hidden">
            <div class="sticky top-[60px] bg-gray-50/95 backdrop-blur p-2 text-[10px] text-gray-500 text-center border-b z-30">æ­·å²æˆäº¤ç´€éŒ„</div>
            <div id="record-list" class="divide-y divide-gray-100 bg-white"></div>
        </div>

        <div id="page-payment" class="p-4 page-content hidden">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200 space-y-4">
                <div class="text-center"><div class="text-4xl mb-2">ğŸ’¸</div><h2 class="text-green-700 font-bold text-xl">åŒ¯æ¬¾ç™»è¨˜</h2></div>
                <div class="bg-gray-50 rounded-xl p-3 border border-gray-200">
                    <div class="flex justify-between items-center mb-2 px-1">
                        <div class="text-xs font-bold text-gray-500">å‹¾é¸ä»¥çµå¸³ (æœ‹å‹å·²è²·é …ç›®)</div>
                        <button onclick="clearChecks()" class="text-[10px] text-blue-500">æ¸…é™¤</button>
                    </div>
                    <div id="buy-checklist" class="space-y-2 max-h-48 overflow-y-auto pr-1"></div>
                </div>
                <div class="space-y-3 pt-2">
                    <input type="date" id="pay-date" class="w-full border border-gray-300 rounded-xl p-3 bg-white text-sm outline-none focus:ring-2 focus:ring-green-500">
                    <div class="relative">
                        <span class="absolute left-4 top-3.5 text-gray-400 text-lg">$</span>
                        <input type="number" id="pay-amount" class="w-full border border-gray-300 rounded-xl p-3 pl-8 bg-white text-xl font-bold text-green-600 outline-none focus:ring-2 focus:ring-green-500" placeholder="0">
                    </div>
                    <input type="text" id="pay-note" class="w-full border border-gray-300 rounded-xl p-3 bg-gray-50 text-xs text-gray-500 outline-none" placeholder="å‚™è¨» (è‡ªå‹•å¡«å¯«)">
                </div>
                <button onclick="submitPayment()" id="btn-pay" class="w-full bg-green-600 hover:bg-green-500 active:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-green-200 transition transform active:scale-[0.98] text-lg">ç¢ºèªå·²åŒ¯æ¬¾</button>
            </div>
        </div>
    </div>

    <nav class="nav-bar safe-pb">
        <button onclick="switchTab('request', 'å§”è¨—ä¸‹å–®')" id="nav-request" class="nav-btn nav-active"><span class="nav-icon">ğŸ“</span><span>ä¸‹å–®</span></button>
        <button onclick="switchTab('pending', 'å¾…è¾¦ç¢ºèª')" id="nav-pending" class="nav-btn relative"><span class="nav-icon">â³</span><span>å¾…è¾¦</span><span id="badge-pending" class="hidden absolute top-2 right-6 w-2 h-2 bg-red-500 rounded-full border border-white"></span></button>
        <button onclick="switchTab('profit', 'æç›Šè©¦ç®—')" id="nav-profit" class="nav-btn"><span class="nav-icon">ğŸ“Š</span><span>æç›Š</span></button>
        <button onclick="switchTab('records', 'æ­·å²ç´€éŒ„')" id="nav-records" class="nav-btn"><span class="nav-icon">ğŸ“œ</span><span>ç´€éŒ„</span></button>
        <button onclick="switchTab('payment', 'åŒ¯æ¬¾ç™»è¨˜')" id="nav-payment" class="nav-btn"><span class="nav-icon">ğŸ’¸</span><span>åŒ¯æ¬¾</span></button>
    </nav>

    <script>
        // ==========================================
        //  ğŸ‘‡ è«‹å°‡ä½ çš„ GAS ç¶²å€è²¼åœ¨ä¸‹æ–¹ ğŸ‘‡
        // ==========================================
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzH8l2y_8LvOOpy-jwTDTKe9VI2gV3AcgaAbI5hh6SX4JqA8De8laq23-oRHU9tTJGp/exec"; 
        // ==========================================

        const today = new Date().toISOString().split('T')[0];
        document.getElementById('req-date').value = today;
        document.getElementById('pay-date').value = today;
        let globalData = { pending: [], records: [] };
        let portfolio = {}; 
        let myChart = null;

        refreshData();

        function switchTab(tabId, title) {
            document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('nav-active'));
            document.getElementById('page-' + tabId).classList.remove('hidden');
            document.getElementById('nav-' + tabId).classList.add('nav-active');
            document.getElementById('page-title').innerText = title;
            const icons = { 'request': 'ğŸ“', 'pending': 'â³', 'profit': 'ğŸ“Š', 'records': 'ğŸ“œ', 'payment': 'ğŸ’¸' };
            document.getElementById('header-icon').innerText = icons[tabId];
            if (tabId === 'pending') renderPending();
            if (tabId === 'records') renderRecords();
            if (tabId === 'profit') calculatePortfolio(); 
            if (tabId === 'payment') renderPaymentChecklist();
        }

        // === 1. ä¿®å¾©ï¼šå¾…è¾¦ç¢ºèª (ä½¿ç”¨ data-attribute é¿å…ç¬¦è™ŸéŒ¯èª¤) ===
        function renderPending() {
            const list = document.getElementById('pending-list');
            const badge = document.getElementById('badge-pending');
            list.innerHTML = '';
            
            if(!globalData.pending || globalData.pending.length===0){ 
                badge.classList.add('hidden'); 
                list.innerHTML=`<div class="text-center py-20 text-gray-300">ç„¡å¾…è¾¦äº‹é …</div>`; 
                return; 
            }
            
            badge.classList.remove('hidden');
            globalData.pending.forEach(item => {
                const isBuy = item[4]==='buy';
                const rawId = item[0].toString();
                // ä½¿ç”¨ data-* å±¬æ€§å„²å­˜è³‡æ–™ï¼Œé¿å… onclick å­—ä¸²è·³è„«å•é¡Œ
                const jsonData = JSON.stringify({
                    id: rawId, ticker: item[3], type: item[4], shares: item[6], date: item[2], price: item[5]
                }).replace(/"/g, '&quot;');

                list.innerHTML += `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-3" id="pending-card-${rawId}">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="px-2 py-0.5 rounded text-xs font-bold ${isBuy?'bg-blue-100 text-blue-600':'bg-red-100 text-red-600'}">${isBuy?'è²·':'è³£'}</span>
                                <span class="font-bold text-lg">${item[3]}</span>
                            </div>
                            <div class="text-xs text-gray-400">å§”è¨—: ${item[6]}è‚¡ @ $${item[5]}</div>
                        </div>
                        <button onclick="showConfirmInput('${rawId}')" class="bg-slate-800 hover:bg-slate-700 text-white text-xs font-bold px-4 py-2 rounded-lg shadow-md active:scale-95 transition">
                            ç¢ºèªæˆäº¤
                        </button>
                    </div>
                    
                    <div id="data-${rawId}" class="hidden" data-json="${jsonData}"></div>

                    <div id="confirm-box-${rawId}" class="hidden mt-3 pt-3 border-t border-gray-100 flex gap-2 items-center animate-fade">
                        <label class="text-xs text-gray-500 whitespace-nowrap">æˆäº¤åƒ¹:</label>
                        <input type="number" id="real-price-${rawId}" value="${item[5]}" class="w-full border border-gray-300 rounded px-2 py-1 text-sm bg-gray-50 focus:bg-white outline-none focus:ring-1 focus:ring-blue-500">
                        <button onclick="doConfirm('${rawId}')" id="btn-submit-${rawId}" class="bg-green-600 text-white text-xs px-3 py-1.5 rounded font-bold whitespace-nowrap">
                            é€å‡º
                        </button>
                        <button onclick="hideConfirmInput('${rawId}')" class="text-gray-400 text-lg px-1">Ã—</button>
                    </div>
                </div>`;
            });
        }

        function showConfirmInput(id) {
            document.getElementById(`confirm-box-${id}`).classList.remove('hidden');
            document.getElementById(`real-price-${id}`).focus();
        }
        function hideConfirmInput(id) {
            document.getElementById(`confirm-box-${id}`).classList.add('hidden');
        }

        function doConfirm(id) {
            // å¾ DOM è®€å–è³‡æ–™
            const dataEl = document.getElementById(`data-${id}`);
            const itemData = JSON.parse(dataEl.getAttribute('data-json'));
            
            const priceInput = document.getElementById(`real-price-${id}`);
            const btn = document.getElementById(`btn-submit-${id}`);
            const realPrice = parseFloat(priceInput.value);

            if (!realPrice || realPrice <= 0) return alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æˆäº¤åƒ¹æ ¼");

            btn.disabled = true;
            btn.innerHTML = '<span class="loader"></span>';

            const payload = {
                action: "confirm_request",
                id: itemData.id,
                date: itemData.date,
                ticker: itemData.ticker,
                type: itemData.type,
                shares: parseInt(itemData.shares),
                price: realPrice,
                amount: Math.round(realPrice * itemData.shares)
            };

            fetch(GAS_URL, { method: "POST", body: JSON.stringify(payload) })
            .then(res => res.json())
            .then(data => {
                alert("ğŸ‰ æˆäº¤å·²ç¢ºèªï¼");
                document.getElementById(`pending-card-${id}`).remove();
                // é€™è£¡ç¨å¾®ç­‰å¾…ä¸€ä¸‹å†é‡æ•´ï¼Œç¢ºä¿ Google Sheets å¯«å…¥å®Œæˆ
                setTimeout(() => {
                    refreshData();
                    switchTab('records', 'æ­·å²ç´€éŒ„');
                }, 500); 
            })
            .catch(err => {
                alert("âŒ é€£ç·šéŒ¯èª¤");
                btn.disabled = false;
                btn.innerText = "é‡è©¦";
            });
        }

        // === 2. é›™å‘è©¦ç®—èˆ‡åœ–è¡¨ ===
        function calcByShares() { const p = parseFloat(document.getElementById('req-price').value)||0; const s = parseInt(document.getElementById('req-shares').value)||0; if(p>0&&s>0) document.getElementById('req-total').value = Math.round(p*s); else document.getElementById('req-total').value = ''; }
        function calcByTotal() { const p = parseFloat(document.getElementById('req-price').value)||0; const t = parseInt(document.getElementById('req-total').value)||0; if(p>0&&t>0) document.getElementById('req-shares').value = Math.floor(t/p); else document.getElementById('req-shares').value = ''; }
        function toggleChart(show) { const el = document.getElementById('chart-wrapper'); if (show) el.classList.add('open'); else el.classList.remove('open'); }
        function fetchHistory() {
            const ticker = document.getElementById('req-ticker').value; const btn = document.getElementById('btn-chart');
            if (!ticker) return alert("è«‹è¼¸å…¥ä»£è™Ÿ");
            btn.disabled = true; btn.innerHTML = '<span class="loader"></span>'; toggleChart(true);
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "get_history", ticker: ticker }) })
            .then(res => res.json()).then(data => { btn.disabled = false; btn.innerHTML = 'ğŸ“ˆ èµ°å‹¢'; if(data.status === 'success') renderChart(data.history); else alert("ç„¡æ³•å–å¾—è³‡æ–™"); })
            .catch(() => { btn.disabled = false; btn.innerHTML = 'ğŸ“ˆ èµ°å‹¢'; });
        }
        function renderChart(historyData) {
            const ctx = document.getElementById('trendChart').getContext('2d'); if (myChart) myChart.destroy();
            const labels = historyData.map(d => d.date); const prices = historyData.map(d => d.price);
            const isUp = prices[prices.length-1] >= prices[0];
            myChart = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'è‚¡åƒ¹', data: prices, borderColor: isUp?'#ef4444':'#22c55e', borderWidth: 2, backgroundColor: isUp?'rgba(239,68,68,0.05)':'rgba(34,197,94,0.05)', fill: true, tension: 0.1, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: true } } } });
        }

        // === 3. æç›Šèˆ‡ç´€éŒ„ ===
        function calculatePortfolio() {
            const list = document.getElementById('portfolio-list'); list.innerHTML = '';
            portfolio = {}; let totalRealizedPL = 0;
            const records = globalData.records || [];
            
            [...records].forEach(item => {
                const ticker = String(item[2]); const type = item[3]; const shares = parseInt(item[5]) || 0; const amount = parseInt(item[6]) || 0; 
                if (!portfolio[ticker]) portfolio[ticker] = { shares: 0, totalCost: 0, avgCost: 0 };
                if (type === 'buy') { portfolio[ticker].shares += shares; portfolio[ticker].totalCost += amount; } 
                else if (type === 'sell') {
                    let avg = portfolio[ticker].shares > 0 ? (portfolio[ticker].totalCost / portfolio[ticker].shares) : 0;
                    let costSold = avg * shares;
                    totalRealizedPL += (amount - costSold);
                    portfolio[ticker].shares -= shares; portfolio[ticker].totalCost -= costSold;
                }
            });

            const realizedEl = document.getElementById('total-realized-pl');
            realizedEl.innerText = `${totalRealizedPL>=0?'+':''}$${Math.round(totalRealizedPL).toLocaleString()}`;
            realizedEl.className = `text-3xl font-bold font-mono tracking-tight ${totalRealizedPL>=0?'text-green-400':'text-red-400'}`;

            let hasStock = false;
            for (let ticker in portfolio) {
                let p = portfolio[ticker];
                if (p.shares > 0) {
                    hasStock = true; 
                    p.avgCost = Math.round(p.totalCost / p.shares * 100) / 100;
                    const card = document.createElement('div');
                    card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-200 transition active:scale-[0.99]";
                    card.id = `card-${ticker}`;
                    card.innerHTML = `<div class="flex justify-between items-start mb-3"><div><div class="font-bold text-xl text-slate-800 tracking-wide">${ticker}</div><div class="text-xs text-gray-400 mt-1">æˆæœ¬å‡åƒ¹: $${p.avgCost.toLocaleString()}</div></div><div class="text-right"><div class="text-sm text-gray-500">æŒæœ‰è‚¡æ•¸</div><div class="text-2xl font-bold text-blue-600 font-mono">${p.shares.toLocaleString()}</div></div></div><div class="flex justify-between text-sm mb-2 bg-slate-50 p-2 rounded-lg"><span class="text-gray-500">é ä¼°ç¾åƒ¹</span><span class="font-mono font-bold text-slate-700" id="price-${ticker}">---</span></div><div class="flex justify-between items-center pt-2 border-t border-gray-100"><span class="text-xs text-gray-400 font-bold">æœªå¯¦ç¾æç›Š</span><span class="font-bold text-lg font-mono" id="pl-${ticker}">$0</span></div>`;
                    list.appendChild(card);
                }
            }
            if (!hasStock) list.innerHTML = `<div class="text-center py-20 text-gray-300 bg-white rounded-2xl border border-dashed border-gray-200">ç„¡åº«å­˜æŒè‚¡</div>`;
        }

        function renderRecords() {
            const list = document.getElementById('record-list'); list.innerHTML = '';
            const records = globalData.records || [];
            if (records.length === 0) { list.innerHTML = `<div class="text-center py-10 text-gray-300">æš«ç„¡æ­·å²ç´€éŒ„</div>`; return; }
            [...records].reverse().forEach(item => {
                const isBuy = item[3]==='buy'; const ticker = item[2]; const date = item[1] ? item[1].substring(0,10) : '----'; const shares = item[5]; const price = item[4]; const amount = parseInt(item[6]).toLocaleString();
                list.innerHTML += `<div class="p-4 flex justify-between items-center hover:bg-gray-50 border-b border-gray-100 transition"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ${isBuy?'bg-blue-100 text-blue-600':'bg-red-100 text-red-600'}">${isBuy?'è²·':'è³£'}</div><div><div class="font-bold text-sm text-slate-700">${ticker} <span class="text-xs font-normal text-gray-400">x${shares}</span></div><div class="text-[10px] text-gray-400">${date}</div></div></div><div class="text-right"><div class="font-bold text-sm font-mono ${isBuy?'text-slate-800':'text-green-600'}">$${amount}</div><div class="text-[10px] text-gray-400 font-mono">@${price}</div></div></div>`;
            });
        }

        // === 4. æ ¸å¿ƒï¼šè³‡æ–™åˆ·æ–° (é˜²æ­¢å¿«å–) ===
        function refreshData() {
            const ind = document.getElementById('status-indicator'); 
            ind.innerText = "â— æ›´æ–°ä¸­"; 
            ind.className="text-[10px] bg-yellow-50 border border-yellow-200 text-yellow-600 px-2 py-1 rounded font-mono cursor-pointer";
            
            // åŠ ä¸Šæ™‚é–“æˆ³è¨˜é˜²æ­¢å¿«å–
            fetch(`${GAS_URL}?t=${new Date().getTime()}`)
            .then(res => res.json())
            .then(data => { 
                globalData = data; 
                if(!globalData.records) globalData.records = [];
                if(!globalData.pending) globalData.pending = [];
                renderPending(); 
                ind.innerText = "â— å·²é€£ç·š"; 
                ind.className="text-[10px] bg-green-50 border border-green-200 text-green-600 px-2 py-1 rounded font-mono cursor-pointer";
            })
            .catch(()=>{ 
                ind.innerText = "âŒ é›¢ç·š (é»æ­¤é‡è©¦)"; 
                ind.className="text-[10px] bg-red-50 border border-red-200 text-red-600 px-2 py-1 rounded font-mono cursor-pointer"; 
            });
        }

        // === å…¶ä»–é€šç”¨ ===
        function submitRequest() {
            const d = {action:"add_request", date:document.getElementById('req-date').value, ticker:document.getElementById('req-ticker').value, type:document.getElementById('req-type').value, price:document.getElementById('req-price').value, shares:document.getElementById('req-shares').value};
            if(!d.price||!d.shares) return alert("è³‡æ–™ä¸å…¨"); document.getElementById('btn-req').disabled=true;
            fetch(GAS_URL, {method:"POST", body:JSON.stringify(d)}).then(res=>res.json()).then(()=>{ alert("âœ… å·²é€å‡º"); document.getElementById('btn-req').disabled=false; refreshData(); switchTab('pending','å¾…è¾¦'); });
        }
        function fetchPrice() {
            const t = document.getElementById('req-ticker').value; const b = document.getElementById('btn-price');
            if(!t) return; b.innerHTML='<span class="loader"></span>'; b.disabled=true;
            fetch(GAS_URL, {method:"POST", body:JSON.stringify({action:"get_price", ticker:t})}).then(res=>res.json()).then(d=>{ if(d.status==='success' && !isNaN(parseFloat(d.price))) { document.getElementById('req-price').value=d.price; calcByShares(); } b.disabled=false; b.innerText='ğŸ” æŠ“ç¾åƒ¹'; });
        }
        function submitPayment() { const v=document.getElementById('pay-amount').value; const n=document.getElementById('pay-note').value; if(!v) return; fetch(GAS_URL, {method:"POST", body:JSON.stringify({action:"add_payment", date:document.getElementById('pay-date').value, amount:v, note:n||"APP"})}).then(()=>{ alert("âœ… å·²åŒ¯æ¬¾"); clearChecks(); }); }
        
        async function updateAllPrices() {
            const btn = document.getElementById('btn-update-all'); btn.disabled = true; btn.innerHTML = '<span class="loader"></span>';
            let totalMarketValue = 0; let totalCostValue = 0;
            const tickers = Object.keys(portfolio).filter(t => portfolio[t].shares > 0);
            for (const ticker of tickers) {
                try {
                    const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "get_price", ticker: ticker }) });
                    const data = await res.json();
                    if (data.status === 'success' && !isNaN(parseFloat(data.price))) {
                        const curPrice = parseFloat(data.price);
                        const shares = portfolio[ticker].shares; const cost = portfolio[ticker].totalCost;
                        const marketVal = Math.round(curPrice * shares); const profit = Math.round(marketVal - cost); 
                        document.getElementById(`price-${ticker}`).innerText = `$${curPrice}`;
                        const plEl = document.getElementById(`pl-${ticker}`);
                        plEl.innerText = `${profit>0?'+':''}$${profit.toLocaleString()}`;
                        plEl.className = `font-bold text-lg font-mono ${profit>=0?'profit-up':'profit-down'}`;
                        totalMarketValue += marketVal; totalCostValue += cost;
                    }
                } catch (e) {}
            }
            document.getElementById('total-market-value').innerText = `$${totalMarketValue.toLocaleString()}`;
            const totalPL = totalMarketValue - totalCostValue;
            const plLabel = document.getElementById('total-unrealized-pl');
            plLabel.innerText = `${totalPL>=0?'+':''}$${totalPL.toLocaleString()}`;
            plLabel.className = `text-3xl font-bold font-mono tracking-tight ${totalPL>=0?'text-red-500':'text-green-500'}`;
            btn.disabled = false; btn.innerHTML = 'ğŸ”„ æ›´æ–°ç¾åƒ¹';
        }

        function renderPaymentChecklist() {
            const list = document.getElementById('buy-checklist'); list.innerHTML = '';
            const buys = [...globalData.records].filter(r => r[3] === 'buy').reverse();
            if (buys.length === 0) { list.innerHTML = `<div class="text-[10px] text-gray-400 text-center py-4">ç„¡é …ç›®</div>`; return; }
            buys.forEach((item, index) => {
                const amount = parseInt(item[6]); const ticker = item[2]; const date = item[1].substring(5, 10); const uid = `chk-${index}`;
                list.innerHTML += `<div class="flex items-center gap-2 bg-white p-2 rounded border border-gray-100 text-xs transition active:bg-blue-50"><input type="checkbox" id="${uid}" class="custom-checkbox flex-shrink-0" onchange="updatePaymentTotal('${ticker}', '${date}', ${amount}, this)"><label for="${uid}" class="flex-1 flex justify-between cursor-pointer select-none"><span class="flex items-center gap-2"><span class="text-gray-400">${date}</span><span class="font-bold text-slate-700">${ticker}</span></span><span class="font-mono font-bold text-green-600">$${amount.toLocaleString()}</span></label></div>`;
            });
        }
        function updatePaymentTotal(ticker, date, amount, checkbox) {
            const amtIn = document.getElementById('pay-amount'); const noteIn = document.getElementById('pay-note');
            let curAmt = parseInt(amtIn.value) || 0; let curNote = noteIn.value; const tag = `${ticker}(${date})`;
            if (checkbox.checked) { curAmt += amount; curNote = !curNote ? `ä»˜: ${tag}` : (!curNote.includes(tag) ? `${curNote}, ${tag}` : curNote); }
            else { curAmt -= amount; curNote = curNote.replace(`, ${tag}`, '').replace(`${tag}, `, '').replace(`ä»˜: ${tag}`, 'ä»˜: ').replace('ä»˜: ,', 'ä»˜: '); if(curNote.trim()==='ä»˜:') curNote=''; }
            amtIn.value = curAmt > 0 ? curAmt : ''; noteIn.value = curNote;
        }
        function clearChecks() { document.querySelectorAll('#buy-checklist input').forEach(c => c.checked = false); document.getElementById('pay-amount').value = ''; document.getElementById('pay-note').value = ''; }
    </script>
</body>
</html>
